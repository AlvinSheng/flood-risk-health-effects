---
title: "Analysis before fitting the CAR model"
author: "Alvin Sheng"
date: "6/28/2021"
output: pdf_document
---

```{r}
library(here)
library(ape)
library(GGally)
library(usdm)
library(spdep)
library(factoextra)
library(tidyverse)
```

```{r}
fhs_model_df <- readRDS(here("intermediary_data/fhs_model_df_all_census_tract_reorg.rds"))
```

# Checking for multicollinearity among the covariates

`S.CARleroux()` automatically puts a fixed ridge penalty on the beta coefficients. Therefore, the large number of covariates and multicollinearity would be accounted for. 

Actually no, because the penalty is negligible. 

## Flood risk variables

```{r}
fr_index <- 14:35
```

```{r}
ggcorr(data = fhs_model_df[, c(fr_index, ncol(fhs_model_df))])
```

```{r}
flood_cor <- cor(fhs_model_df[complete.cases(fhs_model_df[, c(fr_index, ncol(fhs_model_df))]), c(fr_index, ncol(fhs_model_df))])

flood_cor[nrow(flood_cor), ] # correlation with dependent variable
```

For each variable, I take the summary of its correlations with other variables, not including itself. 

```{r}
diag(flood_cor) <- NA

summary(flood_cor)
```

Many of the flood risk variables are very correlated.



# Using VIF to exclude variables

```{r}
fhs_model_df <- readRDS(here("intermediary_data/fhs_model_df_all_census_tract_reorg.rds"))
```

```{r}
X <- fhs_model_df[, 14:(ncol(fhs_model_df) - 1)]

X <- X[, names(X) != "pct_floodfactor1"]

X <- X[, names(X) != "avg_risk_score_sfha"]



X           <- scale(X) # Scale covariates

X <- data.frame(X)
```

```{r}
vif(X)
```

```{r}
vifstep(X)
```

This procedure detects that the following variables have collinearity problems. Let's exclude these variables and then rerun the analysis. 

```{r}
collin_var_names <- c("avg_risk_score_all", "pct_fs_risk_2050_500", "pct_fs_risk_2020_500", "avg_risk_fsf_2020_500", "pct_fs_risk_2050_5", "pct_fs_risk_2020_100", "no2", "pct_fs_risk_2050_100")
```



# Correlations among climate related variables: flood risk, pollution, and GRIDMET variables

Excluding variables in collin_var_names

```{r}
climate_var_idx <- c(fr_index, 52:61)

climate_var_idx_exclude <- climate_var_idx[-which(names(fhs_model_df)[climate_var_idx] %in% collin_var_names)]
```

```{r}
ggcorr(data = fhs_model_df[, c(climate_var_idx_exclude, ncol(fhs_model_df))])
```

```{r}
climate_cor <- cor(fhs_model_df[complete.cases(fhs_model_df[, c(climate_var_idx_exclude, ncol(fhs_model_df))]), c(climate_var_idx_exclude, ncol(fhs_model_df))])

climate_cor[nrow(climate_cor), ] # correlation with dependent variable
```

For each variable, I take the summary of its correlations with other variables, not including itself. 

```{r}
diag(climate_cor) <- NA

summary(climate_cor)
```

Climate variables other than flood risk are not too correlated.




# Non-spatial modeling

```{r}
Y <- fhs_model_df$Data_Value_CHD

X <- fhs_model_df[, 14:(ncol(fhs_model_df) - 1)]

X <- X[, names(X) != "pct_floodfactor1"]

# exclude some more variables selected by vifstep, to account for multicollinearity
# excluding all of the pct_fs_risk variables, as well as 3 of the avg_risk_score variables

collin_var_names <- c("avg_risk_score_all", "pct_fs_risk_2050_500", "pct_fs_risk_2020_500", "avg_risk_fsf_2020_500", "pct_fs_risk_2050_5", "pct_fs_risk_2020_100", "no2", "pct_fs_risk_2050_100")

X <- X[, !(names(X) %in% collin_var_names)]

# also removing avg_risk_score_sfha due to large numbers of NAs
X <- X[, names(X) != "avg_risk_score_sfha"]



X           <- scale(X) # Scale covariates
X[is.na(X)] <- 0        # Fill in missing values with the mean

# if I do mean imputation (which may be problematic), all the counties 
# will have neighbors in W

# X <- data.frame(X)
```

```{r}
fhs_lm <- lm(Y ~ X)
```

```{r}
summary(fhs_lm)
```



# Checking for spatial autocorrelation

```{r}
W <- readRDS(here("intermediary_data", "census_tract_adj_reorganize_all_census_tract.rds"))

W_listw <- mat2listw(W)
```

Moran's I

```{r}
(moran_results <- moran.test(residuals(fhs_lm), W_listw))
```

The *p*-value is negligible, so we can reject the null hypothesis of zero spatial autocorrelation. Since the observed value of I is significantly greater then the expected value, the life expectancies are positively autocorrelated, in contrast to negatively autocorrelated. Thus, using a CAR model is justified. 



# PCA

Conduct PCA on the correlated flood risk variables

```{r}
fr_index <- 14:35

# omitting the 24th variable, avg_risk_score_sfha, because of too many NAs
flood_risk <- fhs_model_df[, fr_index] %>% dplyr::select(-avg_risk_score_sfha)
```

```{r}
fr_pca <- prcomp(flood_risk[complete.cases(flood_risk),], center = T, scale. = T)

fr_loadings <- fr_pca$rotation
```

```{r}
fviz_eig(fr_pca)
```

```{r}
summ_pca <- summary(fr_pca)

summ_pca$importance[,1:10]
```

We started out with 22 variables. Including four PC scores would include 80% of the variance.

Including seven PC scores would include 90% of the variance.



Printing out the loadings, from most negative to least

```{r}
# First PC Score
fr_loadings[order(fr_loadings[, 1]), 1]
```

The first PC score is very interpretable. Only the loading for pct_floodfactor1 is positive.

```{r}
# Second PC Score
fr_loadings[order(fr_loadings[, 2]), 2]
```

Less interpretable--more of a mix of positive and negative loadings.

```{r}
# Third PC Score
fr_loadings[order(fr_loadings[, 3]), 3]
```

```{r}
# Fourth PC Score
fr_loadings[order(fr_loadings[, 4]), 4]
```



